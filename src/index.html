<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Delirious</title>

    <!-- uncomment this only when making video -->
    <!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@1,400&display=swap" rel="stylesheet"> -->
    <script>
      let search = new URLSearchParams(window.location.search)
      let alphabet = "123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"
      let b58dec = (str) =>
        [...str].reduce(
          (p, c) => (p * alphabet.length + alphabet.indexOf(c)) | 0,
          0
        )
      // make fxrand from hash
      let hash =
        search.get("fxhash") ||
        "vedrrran" +
          Array(49)
            .fill(0)
            .map((_) => alphabet[(Math.random() * alphabet.length) | 0])
            .join("")
      const randomSeedEditArt = hash;
      // const randomSeedEditArt = 'vedrrranfnTYQxRPuzJhWwdUMDP9yTehpwyaX4PXVViYRMZdinqG9qvFz';
      console.log('randomSeedEditArt', randomSeedEditArt);
    </script>
    <script id="editart-snippet">
      parent.postMessage({ editArtTemplateVersion: 1 }, "*");

      window.capturePreview = false;
      function triggerPreview() {
          if(!window.capturePreview) console.log('Trigger preview')
          window.capturePreview = true;
      }

      let m0 = 0.5;
      let m1 = 0.5;
      let m2 = 0.5;
      let m3 = 0.5;
      let m4 = 0.5;

      let randomM0;
      let randomM1;
      let randomM2;
      let randomM3;
      let randomM4;

      const queryString = window.location.search;
      console.log(queryString);
      if (queryString) {
          getParams(queryString);
      }
      triggerDraw();

      function truncate(i) {
          return Math.max(Math.min(i, 0.99999999), 0);
      }
      function getParam(urlParams, p) {
          const param = urlParams.get(p);
          if (param) {
              return truncate(parseFloat(param));
          }
          return null;
      }

      function getParams(queryString) {
          const urlParams = new URLSearchParams(queryString);
          m0 = getParam(urlParams, "m0");
          m1 = getParam(urlParams, "m1");
          m2 = getParam(urlParams, "m2");
          m3 = getParam(urlParams, "m3");
          m4 = getParam(urlParams, "m4");
      }
      window.addEventListener("message", (e) => {
          var data = e.data;
          if (data.hasOwnProperty("editartQueryString")) {
              getParams(data["editartQueryString"]);
              triggerDraw();
          }
      });

      function triggerDraw() {
          seedRandomness();
          drawArt();
          parent.postMessage("editArtSketchLoaded", "*");
      }

      window.addEventListener("resize", (e) => triggerDraw());

      function getRNG(num) {
          return sfc32(...cyrb128(randomSeedEditArt + num.toString()));
      }

      function seedRandomness() {
          randomM0 = getRNG(m0);
          randomM1 = getRNG(m1);
          randomM2 = getRNG(m2);
          randomM3 = getRNG(m3);
          randomM4 = getRNG(m4);
      }

      function cyrb128(str) {
          let h1 = 1779033703,
              h2 = 3144134277,
              h3 = 1013904242,
              h4 = 2773480762;
          for (let i = 0, k; i < str.length; i++) {
              k = str.charCodeAt(i);
              h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
              h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
              h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
              h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
          }
          h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
          h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
          h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
          h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
          return [
              (h1 ^ h2 ^ h3 ^ h4) >>> 0,
              (h2 ^ h1) >>> 0,
              (h3 ^ h1) >>> 0,
              (h4 ^ h1) >>> 0,
          ];
      }

      function sfc32(a, b, c, d) {
          return function () {
              a >>>= 0;
              b >>>= 0;
              c >>>= 0;
              d >>>= 0;
              var t = (a + b) | 0;
              a = b ^ (b >>> 9);
              b = (c + (c << 3)) | 0;
              c = (c << 21) | (c >>> 11);
              d = (d + 1) | 0;
              t = (t + d) | 0;
              c = (c + t) | 0;
              return (t >>> 0) / 4294967296;
          };
      }
    </script>
    <link rel="stylesheet" href="css/styles.scss" />
  </head>
  <body>
    <!-- uncomment this only when making video -->
    <!-- <p class="headline">COMPONENTS</p> -->
    <div id="preloader" class="preloader">
      <p id="preloader-text">â€¢</p>
    </div>
    <script type="module" src="js/app.js"></script>
  </body>
</html>